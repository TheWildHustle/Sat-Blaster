(function(d,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(d=typeof globalThis<"u"?globalThis:d||self,h(d.irisdb={}))})(this,function(d){"use strict";var A=Object.defineProperty;var C=(d,h,p)=>h in d?A(d,h,{enumerable:!0,configurable:!0,writable:!0,value:p}):d[h]=p;var g=(d,h,p)=>(C(d,typeof h!="symbol"?h+"":h,p),p);class h{constructor(t){g(this,"channel");this.channel=new BroadcastChannel(t)}get(t,e){const s=i=>{const{path:n,value:o,updatedAt:c}=JSON.parse(i.data);n===t&&e(o,t,c,()=>this.channel.removeEventListener("message",s))};return this.channel.addEventListener("message",s),()=>this.channel.removeEventListener("message",s)}async set(t,e){if(e&&e.updatedAt===void 0)throw new Error(`Invalid value: ${JSON.stringify(e)}`);const s=JSON.stringify({path:t,value:e.value,updatedAt:e.updatedAt});this.channel.postMessage(s)}list(t,e){const s=i=>{const{path:n,value:o,updatedAt:c}=JSON.parse(i.data);if(n.startsWith(`${t}/`)){const r=n.substring(t.length+1);r.includes("/")||e(o,r,c,()=>this.channel.removeEventListener("message",s))}};return this.channel.addEventListener("message",s),()=>this.channel.removeEventListener("message",s)}}class p{constructor(){g(this,"storage",new Map);g(this,"isLoaded",!1);g(this,"loadingPromise");g(this,"resolveLoading",null);this.loadingPromise=new Promise(t=>{this.resolveLoading=t}),this.loadFromLocalStorage()}loadFromLocalStorage(){for(let t=0;t<localStorage.length;t++){const e=localStorage.key(t);let s;try{s=localStorage.getItem(e)||"",s=JSON.parse(s)}catch{}this.storage.set(e,s)}this.isLoaded=!0,this.resolveLoading&&this.resolveLoading()}listFromStorage(t,e){for(const[s,i]of this.storage){const n=s.replace(`${t}/`,"");s.startsWith(`${t}/`)&&n.length&&!n.includes("/")&&e(i.value,s,i.updatedAt,()=>{})}}get(t,e){const s=this.storage.get(t)||{value:void 0,updatedAt:void 0};return e(s.value,t,s.updatedAt,()=>{}),this.isLoaded||this.loadingPromise.then(()=>{const i=this.storage.get(t)||{value:void 0,updatedAt:void 0};i!==s&&e(i.value,t,i.updatedAt,()=>{})}),()=>{}}async set(t,e){if(e.updatedAt===void 0)throw new Error(`Invalid value: ${JSON.stringify(e)}`);this.storage.set(t,e),localStorage.setItem(t,JSON.stringify(e))}list(t,e){return this.listFromStorage(t,e),this.isLoaded||this.loadingPromise.then(()=>{this.listFromStorage(t,e)}),()=>{}}}class j{constructor(){g(this,"storage",new Map)}get(t,e){const s=this.storage.get(t)||{value:void 0,updatedAt:void 0};return e(s.value,t,s.updatedAt,()=>{}),()=>{}}async set(t,e){if(e.updatedAt===void 0)throw new Error(`Invalid value: ${JSON.stringify(e)}`);e===void 0?this.storage.delete(t):this.storage.set(t,e)}list(t,e){for(const[s,i]of this.storage){const n=s.replace(`${t}/`,"");s.startsWith(`${t}/`)&&n.length&&!n.includes("/")&&e(i.value,s,i.updatedAt,()=>{})}return()=>{}}}const N=Object.freeze(Object.defineProperty({__proto__:null,BroadcastChannelAdapter:h,LocalStorageMemoryAdapter:p,MemoryAdapter:j},Symbol.toStringTag,{value:"Module"})),L={},S=b=>typeof b=="object"&&b!==null&&Object.keys(b).length===0&&!Array.isArray(b);class E{constructor({id:t="",adapters:e,parent:s=null}={}){g(this,"id");g(this,"parent");g(this,"children",new Map);g(this,"onSubscriptions",new Map);g(this,"forEachSubscriptions",new Map);g(this,"adapters");g(this,"counter",0);this.id=t,this.parent=s,this.adapters=e??(s==null?void 0:s.adapters)??[new p]}get(t){const e=t.split("/");let s=this.children.get(e[0]);return s||(s=new E({id:`${this.id}/${e[0]}`,parent:this}),this.children.set(e[0],s)),e.length>1?s.get(e.slice(1).join("/")):s}async putValue(t,e,s){S(t)||(this.children=new Map);const i={updatedAt:e,value:t,expiresAt:s},n=this.adapters.map(o=>o.set(this.id,i));this.notifyChange(t,e),await Promise.all(n)}async putChildValues(t,e,s){const i=this.adapters.map(c=>c.set(this.id,{value:L,updatedAt:e,expiresAt:s})),o=Object.keys(t).map(c=>this.get(c).put(t[c],e));await Promise.all([...i,...o])}async put(t,e=Date.now(),s){if(typeof t=="object"&&t!==null&&!Array.isArray(t)&&Object.keys(t).length?await this.putChildValues(t,e,s):await this.putValue(t,e,s),this.parent){await this.parent.put(L,e);const i=this.id.split("/").pop();this.parent.children.has(i)||this.parent.children.set(i,this);for(const[n,{callback:o,recursion:c}]of this.parent.forEachSubscriptions)(!S(t)||c===0)&&o(t,this.id,e,()=>{var r;(r=this.parent)==null||r.forEachSubscriptions.delete(n)})}}open(t,e=0,s=i=>i){const i={};let n;return this.forEach((o,c,r)=>{r!==void 0&&(!n||n<r)&&(n=r);const m=c.split("/").pop();i[m]=o,t(s(i),c.split("/").slice(0,-1).join("/"),n,()=>{})},e)}on(t,e=!1,s=1,i=o=>o,n=!0){let o=null;const c=new Map;let r;const m=this.counter++,w=(a,f,l,y)=>{const P=o!==null&&l!==void 0&&o.updatedAt>=l;if(!e&&a===void 0||n&&P)return;if(!n&&l!==void 0){const M=c.get(f);if(M&&M.updatedAt>=l)return;c.set(f,{value:a,updatedAt:l})}if(!o&&e&&a===void 0){t(a,f,l,y);return}a!==void 0&&l!==void 0&&(o={value:a,updatedAt:l}),S(a)&&s>0&&!r&&(r=this.open(t,s-1,i)),(!S(a)||s===0)&&t(i(a),f,l,y)};this.onSubscriptions.set(m,{callback:w,recursion:s});const v=this.adapters.map(a=>a.get(this.id,w));return()=>{this.onSubscriptions.delete(m),v.forEach(a=>a()),r==null||r()}}notifyChange(t,e){this.onSubscriptions.forEach(({callback:s,recursion:i})=>{i>0&&S(t)||s(t,this.id,e,()=>{})})}forEach(t,e=0,s=i=>i){const i=this.counter++,n=(u,a,f,l)=>{t(s(u),a,f,l)};this.forEachSubscriptions.set(i,{callback:n,recursion:e});const o=new Map;let c=[];const r={},m=()=>{c.forEach(u=>u())},w=(u,a,f)=>{const l=o.get(a);if(f!==void 0&&l&&l.updatedAt>=f)return;f!==void 0&&o.set(a,{value:u,updatedAt:f});const y=a.split("/").pop();e>0&&u&&S(u)?r[y]||(r[y]=this.get(y).open(t,e-1)):t(u,a,f,()=>{this.forEachSubscriptions.delete(i),m(),Object.values(r).forEach(P=>P())})};return c=this.adapters.map(u=>u.list(this.id,(a,f,l,y)=>(w(s(a),f,l),()=>{}))),()=>{this.forEachSubscriptions.delete(i),m(),Object.values(r).forEach(u=>u())}}once(t,e=!1,s=1,i=n=>n){return new Promise(n=>{let o=!1;const c=(r,m,w,v)=>{o||(o=!0,n(r),t==null||t(r,m,w,()=>{}),v())};this.on(c,e,s,i)})}}const O="localState",V=new E({id:O,adapters:[new p,new h(O)]});d.Adapters=N,d.DIRECTORY_VALUE=L,d.Node=E,d.isDirectory=S,d.localState=V,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
